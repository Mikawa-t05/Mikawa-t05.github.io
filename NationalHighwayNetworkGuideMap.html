<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国国道網便覧マップ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        .route-link {
            display: block;
            margin: 4px 0;
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .full-screen {
            width: 100vw;
            height: 100vh;
            background-color: lightblue;
            /* 任意の背景色 */
        }
    </style>
</head>


<body>
    <select id="layerSelector" style="position: absolute; z-index: 1000; top: 10px; right: 10px;">
        <option value="pale">淡色地図</option>
        <option value="white">白地図</option>
        <option value="picture">航空写真</option>
    </select>

    <select id="routeTypeSelector" style="position: absolute; z-index: 1000; top: 35px; right: 10px;">
        <option value="all">全て</option>
        <option value="tollOnly">有料のみ</option>
        <option value="nonToll">有料以外</option>
        <option value="dghOnly">直管国道のみ</option>
        <option value="subsidOnly">補助国道のみ</option>
    </select>


    <div id="map" class="full-screen"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([35.684036, 139.774467], 15);

        // 背景レイヤー定義
        const layers = {
            pale: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
                maxZoom: 16,
            }),
            white: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
                maxZoom: 14,
            }),
            picture: L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
                maxZoom: 18,
            }),
        };

        // 初期レイヤー追加
        layers.pale.addTo(map);
        let currentLayer = layers.pale;

        // セレクトボックスでレイヤー切り替え
        document.getElementById('layerSelector').addEventListener('change', function () {
            const selected = this.value;
            if (layers[selected]) {
                map.removeLayer(currentLayer);
                currentLayer = layers[selected];
                currentLayer.addTo(map);
            }
        });


        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
            maxZoom: 18,
        }).addTo(map);

        let allFeatures = [];
        let geojsonLayer;

        fetch('route.geojson')
            .then(res => res.json())
            .then(data => {
                allFeatures = data.features;

                // 優先順位に従って並び替え
                const sortedFeatures = allFeatures.slice().sort((a, b) => {
                    const getPriority = (f) => {
                        const isToll = f.properties.toll_road === 1;
                        const isDGH = f.properties.DGH_Route === 1;
                        if (isToll && isDGH) return 4; // 最前面：直管有料道路
                        if (isToll) return 3;          // 補助有料道路
                        if (isDGH) return 2;           // 直管国道
                        return 1;                      // 補助国道（最背面）
                    };
                    return getPriority(a) - getPriority(b);
                });

                geojsonLayer = L.geoJSON({ type: "FeatureCollection", features: sortedFeatures }, {
                    style: getStyle,
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            const clickedCoords = JSON.stringify(feature.geometry.coordinates);

                            const sameRouteFeatures = allFeatures.filter(f =>
                                JSON.stringify(f.geometry.coordinates) === clickedCoords
                            );

                            sameRouteFeatures.sort((a, b) => a.properties.Rd_SortNo - b.properties.Rd_SortNo);

                            let popupContent = '';
                            if (sameRouteFeatures.length === 1) {
                                const f = sameRouteFeatures[0];
                                popupContent = generateInfoHTML(f);
                                highlightRoutes(f);
                            } else {
                                const linksHTML = sameRouteFeatures.map((f, i) => {
                                    return `<a class="route-link" data-index="${i}">${f.properties.route_name}</a>`;
                                }).join('');
                                popupContent = `
                          <div><strong>路線を選択：</strong></div>
                          ${linksHTML}
                          <div id="routeInfo">${generateInfoHTML(sameRouteFeatures[0])}</div>
                        `;
                                highlightRoutes(sameRouteFeatures[0]);

                                setTimeout(() => {
                                    document.querySelectorAll('.route-link').forEach(link => {
                                        link.addEventListener('click', (e) => {
                                            const index = e.target.getAttribute('data-index');
                                            const selected = sameRouteFeatures[index];
                                            document.getElementById('routeInfo').innerHTML = generateInfoHTML(selected);
                                            highlightRoutes(selected);
                                        });
                                    });
                                }, 100);
                            }

                            layer.bindPopup(popupContent).openPopup();
                        });
                    }
                }).addTo(map);
            });


        function getStyle(feature) {
            const isToll = feature.properties.toll_road === 1;
            const isDGH = feature.properties.DGH_Route === 1;

            if (isToll && isDGH) return { color: '#633F98', weight: 4 }; // 直管有料道路
            if (isToll) return { color: '#B17CFF', weight: 3 };          // 補助有料道路
            if (isDGH) return { color: '#EC1B24', weight: 3 };            // 直管国道
            return { color: '#EA86B7', weight: 2 };                        // 補助国道
        }


        function generateInfoHTML(feature) {
            const tollText = feature.properties.toll_road === 1 ? '有料区間名　' : '通称名';
            const nickText = feature.properties.nick_name ? `<tr><td>${tollText}</td><td>${feature.properties.nick_name}</td></tr>` : '';
            const Rd_adminText = feature.properties.DGH_Route === 1 ? '直管国道' : '補助国道';
            const length = feature.properties.length;
            return `
        <table>
        <tr><td><strong>路線名</strong></td><td>${feature.properties.route_name}</td><tr>
        ${nickText}
        <tr><td>道路の種類　</td><td>${feature.properties.route_type}</td></tr>
        <tr><td></td><td>${Rd_adminText}</td></tr>
        <tr><td>延長※</td><td>約 ${length} m</td></tr>
        </table>
        <a href="Route${feature.properties.Rd_SortNo}.html">詳細情報</a>
      `;
        }

        function highlightRoutes(selectedFeature) {
            geojsonLayer.eachLayer(layer => {
                const f = layer.feature;
                if (JSON.stringify(f.geometry.coordinates) === JSON.stringify(selectedFeature.geometry.coordinates)) {
                    layer.setStyle({ color: 'cyan', weight: 5 }); // 選択された地物
                    layer.bringToFront();
                } else {
                    layer.setStyle(getStyle(f)); // 元の色に戻す
                }
            });
        }

        document.getElementById('routeTypeSelector').addEventListener('change', function () {
            const selectedType = this.value;
            const filtered = filterFeaturesByType(selectedType);
            updateGeoJsonLayer(filtered);
        });

        function filterFeaturesByType(type) {
            return allFeatures.filter(f => {
                const isToll = f.properties.toll_road === 1;
                const isDGH = f.properties.DGH_Route === 1;

                switch (type) {
                    case 'tollOnly':
                        return isToll;
                    case 'nonToll':
                        return !isToll;
                    case 'dghOnly':
                        return isDGH;
                    case 'subsidOnly':
                        return !isDGH;
                    case 'all':
                    default:
                        return true;
                }
            });
        }

        function updateGeoJsonLayer(features) {
            if (geojsonLayer) {
                map.removeLayer(geojsonLayer);
            }

            const sortedFeatures = features.slice().sort((a, b) => {
                const getPriority = (f) => {
                    const isToll = f.properties.toll_road === 1;
                    const isDGH = f.properties.DGH_Route === 1;
                    if (isToll && isDGH) return 4;
                    if (isToll) return 3;
                    if (isDGH) return 2;
                    return 1;
                };
                return getPriority(a) - getPriority(b);
            });

            geojsonLayer = L.geoJSON({ type: "FeatureCollection", features: sortedFeatures }, {
                style: getStyle,
                onEachFeature: (feature, layer) => {
                    // 既存のクリックイベント処理をここに再利用
                    layer.on('click', () => {
                        const clickedCoords = JSON.stringify(feature.geometry.coordinates);

                        const sameRouteFeatures = allFeatures.filter(f =>
                            JSON.stringify(f.geometry.coordinates) === clickedCoords
                        );

                        sameRouteFeatures.sort((a, b) => a.properties.Rd_SortNo - b.properties.Rd_SortNo);

                        let popupContent = '';
                        if (sameRouteFeatures.length === 1) {
                            const f = sameRouteFeatures[0];
                            popupContent = generateInfoHTML(f);
                            highlightRoutes(f);
                        } else {
                            const linksHTML = sameRouteFeatures.map((f, i) => {
                                return `<a class="route-link" data-index="${i}">${f.properties.route_name}</a>`;
                            }).join('');
                            popupContent = `
                          <div><strong>路線を選択：</strong></div>
                          ${linksHTML}
                          <div id="routeInfo">${generateInfoHTML(sameRouteFeatures[0])}</div>
                        `;
                            highlightRoutes(sameRouteFeatures[0]);

                            setTimeout(() => {
                                document.querySelectorAll('.route-link').forEach(link => {
                                    link.addEventListener('click', (e) => {
                                        const index = e.target.getAttribute('data-index');
                                        const selected = sameRouteFeatures[index];
                                        document.getElementById('routeInfo').innerHTML = generateInfoHTML(selected);
                                        highlightRoutes(selected);
                                    });
                                });
                            }, 100);
                        }

                        layer.bindPopup(popupContent).openPopup();
                    });
                }
            }).addTo(map);
        }

        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.background = 'white';
            div.style.padding = '10px';
            div.style.border = '1px solid #ccc';
            div.innerHTML += '<strong>路線種別凡例</strong><br>';
            div.innerHTML += '<div style="border-top: 4px solid #633F98; margin: 4px 0;">直管国道(有料)</div>';
            div.innerHTML += '<div style="border-top: 3px solid #B17CFF; margin: 4px 0;">補助国道(有料)</div>';
            div.innerHTML += '<div style="border-top: 3px solid #EC1B24; margin: 4px 0;">直管国道</div>';
            div.innerHTML += '<div style="border-top: 2px solid #EA86B7; margin: 4px 0;">補助国道</div>';
            div.innerHTML += '<div style="border-top: 5px solid cyan; margin: 4px 0;">選択中の路線</div>';
            return div;
        };

        legend.addTo(map);

    </script>
</body>

</html>